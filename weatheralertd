#!/bin/sh

REGION="$(curl -sf https://ipapi.co/json/ | jq -r '.region_code // empty')"
[ -z "$REGION" ] && echo "Could not determine region." && exit 1

URL="https://api.weather.gov/alerts/active/area/$REGION"

ALERT_FILE="/tmp/weatheralert.$$.alert"
ALERT_NEW_FILE="/tmp/weatheralert.$$.alert.new"
SLEEPTIME=60

trap 'rm -f "$ALERT_FILE" "$ALERT_NEW_FILE"' EXIT INT TERM

_getalert() {
    curl -sf "$URL" | jq -r '[.features[].properties.headline // empty] | join("\n")'
}

if _getalert > "$ALERT_FILE"; then
    [ -s "$ALERT_FILE" ] && notify-send "$(< "$ALERT_FILE")"
fi

while true; do
    if _getalert > "$ALERT_NEW_FILE"; then
        if ! cmp -s "$ALERT_FILE" "$ALERT_NEW_FILE"; then
            mv "$ALERT_NEW_FILE" "$ALERT_FILE"
            [ -s "$ALERT_FILE" ] && notify-send "$(< "$ALERT_FILE")"
        fi
    else
        echo "Failed to fetch alerts."
    fi

    sleep "$SLEEPTIME"
done
